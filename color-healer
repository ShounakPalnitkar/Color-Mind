<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø Therapeutic Color Therapy Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
        :root {
            --primary-bg: #0c0c2e;
            --secondary-bg: #1a1a3e;
            --card-bg: rgba(40, 40, 60, 0.9);
            --accent-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-purple: #9b59b6;
            --accent-red: #e74c3c;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(30, 30, 50, 0.95);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }

        h1 {
            color: var(--text-primary);
            font-size: 3rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 10s ease infinite;
            background-size: 200% 200%;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.3rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .upload-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            border: 2px dashed rgba(52, 152, 219, 0.5);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .results-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .feature-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .toggle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: var(--accent-blue);
        }

        .toggle-btn.active {
            background: linear-gradient(45deg, 
                rgba(52, 152, 219, 0.2), 
                rgba(46, 204, 113, 0.2));
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .form-group h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        select, input {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(20, 20, 30, 0.9);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        select option {
            background: #1a1a2e;
            color: white;
            padding: 10px;
        }

        .health-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .health-option {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .health-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .health-option.selected {
            background: linear-gradient(45deg, 
                rgba(52, 152, 219, 0.2), 
                rgba(155, 89, 182, 0.2));
            color: white;
            border-color: var(--accent-purple);
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.3);
        }

        .symptom-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .symptom-option {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .symptom-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .symptom-option.selected {
            background: rgba(231, 76, 60, 0.2);
            color: white;
            border-color: var(--accent-red);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .time-option {
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .time-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .time-option.selected {
            background: linear-gradient(45deg, 
                rgba(46, 204, 113, 0.2), 
                rgba(52, 152, 219, 0.2));
            color: white;
            border-color: var(--accent-green);
        }

        .file-upload {
            position: relative;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 3px dashed rgba(52, 152, 219, 0.5);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            background: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.8);
            box-shadow: 0 0 40px rgba(52, 152, 219, 0.2);
        }

        .file-upload i {
            font-size: 4rem;
            margin-bottom: 15px;
            display: block;
            color: var(--accent-blue);
            text-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
        }

        .file-upload span {
            color: var(--text-secondary);
            font-size: 1.1rem;
            display: block;
            margin-bottom: 10px;
        }

        .file-upload .upload-types {
            color: var(--accent-blue);
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #fileInput {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            top: 0;
            left: 0;
        }

        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            display: none;
            margin-top: 20px;
            border: 2px solid rgba(52, 152, 219, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            width: 100%;
            padding: 20px;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-green));
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(52, 152, 219, 0.4);
            background: linear-gradient(45deg, #2980b9, #27ae60);
        }

        .btn-primary:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-top: 20px;
        }

        .spinner {
            border: 5px solid rgba(243, 243, 243, 0.1);
            border-top: 5px solid var(--accent-blue);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .wellness-score {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, 
                rgba(52, 152, 219, 0.2) 0%, 
                rgba(46, 204, 113, 0.2) 100%);
            border-radius: 20px;
            border: 2px solid rgba(52, 152, 219, 0.3);
        }

        .wellness-score h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: white;
        }

        .wellness-score .score {
            font-size: 5rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(46, 204, 113, 0.3);
        }

        .prescription-card {
            text-align: center;
            padding: 25px;
            margin: 25px 0;
            background: linear-gradient(135deg, 
                rgba(155, 89, 182, 0.8) 0%, 
                rgba(52, 152, 219, 0.8) 100%);
            border-radius: 20px;
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 15px 35px rgba(155, 89, 182, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .triple-layer {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .layer-card {
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            color: white;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .layer-1 {
            background: linear-gradient(135deg, 
                rgba(52, 152, 219, 0.8) 0%, 
                rgba(155, 89, 182, 0.8) 100%);
        }

        .layer-2 {
            background: linear-gradient(135deg, 
                rgba(46, 204, 113, 0.8) 0%, 
                rgba(26, 188, 156, 0.8) 100%);
        }

        .layer-3 {
            background: linear-gradient(135deg, 
                rgba(231, 76, 60, 0.8) 0%, 
                rgba(243, 156, 18, 0.8) 100%);
        }

        .color-section {
            margin: 30px 0;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .color-section h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-palette {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .color-swatch-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90px;
            transition: transform 0.3s;
        }

        .color-swatch-container:hover {
            transform: translateY(-5px);
        }

        .color-swatch {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 3px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px currentColor;
            border-color: rgba(255, 255, 255, 0.6);
        }

        .sound-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sound-icon:hover {
            background: var(--accent-blue);
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }

        .color-label {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 3px;
            font-weight: 500;
        }

        .color-hex {
            text-align: center;
            font-size: 0.8rem;
            color: var(--accent-blue);
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .audio-section {
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, 
                rgba(26, 26, 46, 0.9) 0%, 
                rgba(22, 33, 62, 0.9) 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(52, 152, 219, 0.3);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .audio-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-green));
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 25px rgba(52, 152, 219, 0.4);
        }

        .audio-btn.stop {
            background: linear-gradient(45deg, var(--accent-red), #c0392b);
        }

        .volume-control {
            flex: 1;
            min-width: 200px;
        }

        .volume-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-green));
            cursor: pointer;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .audio-visualizer {
            height: 100px;
            margin-top: 20px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .audio-bar {
            flex: 1;
            background: linear-gradient(to top, var(--accent-blue), var(--accent-purple));
            border-radius: 3px 3px 0 0;
            min-height: 2px;
            transition: height 0.1s;
            box-shadow: 0 0 10px rgba(155, 89, 182, 0.3);
        }

        .playlist-section {
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, 
                rgba(44, 62, 80, 0.9) 0%, 
                rgba(52, 73, 94, 0.9) 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .playlist-track {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.07);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .playlist-track:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .playlist-track.active {
            background: rgba(52, 152, 219, 0.25);
            border-left: 5px solid var(--accent-blue);
            box-shadow: inset 0 0 0 1px rgba(52, 152, 219, 0.3);
        }

        .track-number {
            width: 35px;
            text-align: center;
            font-weight: 700;
            color: var(--accent-blue);
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }

        .track-info {
            flex: 1;
        }

        .track-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .track-duration {
            font-size: 0.9rem;
            opacity: 0.8;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .track-color {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 15px currentColor;
        }

        .data-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 35px 0;
        }

        .data-card {
            background: rgba(40, 40, 60, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.3);
        }

        .data-card h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-metric {
            font-size: 3.5rem;
            font-weight: 900;
            text-align: center;
            margin: 15px 0;
            background: linear-gradient(45deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(52, 152, 219, 0.2);
        }

        .data-label {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .sentiment-meter {
            height: 25px;
            background: linear-gradient(90deg, 
                #e74c3c 0%, 
                #f1c40f 50%, 
                #2ecc71 100%);
            border-radius: 12px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .sentiment-indicator {
            position: absolute;
            width: 5px;
            height: 35px;
            background: #2c3e50;
            top: -5px;
            transform: translateX(-50%);
            box-shadow: 0 0 15px rgba(44, 62, 80, 0.5);
            z-index: 2;
        }

        .sentiment-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .color-frequency-chart {
            height: 180px;
            display: flex;
            align-items: flex-end;
            gap: 6px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .frequency-column {
            flex: 1;
            background: linear-gradient(to top, var(--accent-blue), var(--accent-green));
            border-radius: 8px 8px 0 0;
            position: relative;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
            transition: height 0.5s ease;
        }

        .frequency-value {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        .emotion-wheel {
            width: 280px;
            height: 280px;
            margin: 20px auto;
            position: relative;
            border-radius: 50%;
            background: conic-gradient(
                #ff6b6b 0deg 60deg,
                #ffd166 60deg 120deg,
                #06d6a0 120deg 180deg,
                #118ab2 180deg 240deg,
                #9d4edd 240deg 300deg,
                #ff9e6d 300deg 360deg
            );
            box-shadow: 0 0 60px rgba(255, 107, 107, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .emotion-pointer {
            position: absolute;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #2c3e50, #34495e);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
            border: 3px solid rgba(255, 255, 255, 0.3);
            z-index: 2;
            text-transform: uppercase;
        }

        .alert {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
            text-align: center;
            animation: slideIn 0.5s ease;
            font-weight: 600;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-error {
            background-color: rgba(231, 76, 60, 0.25);
            color: #ffcccc;
            border: 2px solid rgba(231, 76, 60, 0.4);
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.2);
        }

        .alert-success {
            background-color: rgba(46, 204, 113, 0.25);
            color: #ccffdd;
            border: 2px solid rgba(46, 204, 113, 0.4);
            box-shadow: 0 10px 25px rgba(46, 204, 113, 0.2);
        }

        .therapy-tips {
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, 
                rgba(26, 188, 156, 0.1) 0%, 
                rgba(52, 152, 219, 0.1) 100%);
            border-radius: 20px;
            border: 2px solid rgba(52, 152, 219, 0.2);
        }

        .therapy-tips h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tips-list {
            list-style-type: none;
            padding-left: 0;
        }

        .tips-list li {
            padding: 15px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.07);
            border-radius: 10px;
            border-left: 5px solid var(--accent-blue);
            transition: transform 0.2s;
            color: var(--text-secondary);
        }

        .tips-list li:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        footer p {
            margin-bottom: 10px;
        }

        /* Environment Analysis Styles */
        .environment-analysis {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .analysis-card {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        .analysis-card h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .analysis-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        .analysis-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Color Breathing Guide */
        .breathing-guide {
            text-align: center;
            padding: 30px;
            margin: 30px 0;
            background: linear-gradient(135deg, 
                rgba(155, 89, 182, 0.1) 0%, 
                rgba(52, 152, 219, 0.1) 100%);
            border-radius: 20px;
            border: 2px solid rgba(155, 89, 182, 0.2);
        }

        .breathing-circle {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple));
            animation: breathe 8s infinite ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 40px rgba(155, 89, 182, 0.4);
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .main-content {
                gap: 20px;
            }
            
            .feature-toggle {
                flex-direction: column;
            }
            
            .toggle-btn {
                min-width: 100%;
            }
            
            .health-grid,
            .symptom-grid,
            .time-grid {
                grid-template-columns: 1fr;
            }
            
            .triple-layer {
                grid-template-columns: 1fr;
            }
            
            .environment-analysis {
                grid-template-columns: 1fr;
            }
            
            .data-dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar Styling */
        .results-section::-webkit-scrollbar {
            width: 8px;
        }

        .results-section::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .results-section::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple));
            border-radius: 4px;
        }

        /* Color Therapy Visualizations */
        .circadian-chart {
            height: 200px;
            margin: 20px 0;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
        }

        .circadian-wave {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(52, 152, 219, 0.6), rgba(155, 89, 182, 0.6));
            border-radius: 10px 10px 0 0;
            transition: height 0.5s ease;
        }

        .color-therapy-timeline {
            display: flex;
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .therapy-time-slot {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .therapy-time-slot:hover {
            transform: scale(1.05);
            z-index: 1;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.2);
        }

        /* Print Styles */
        @media print {
            .container {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .audio-section,
            .audio-controls,
            .audio-visualizer,
            .btn-primary {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåø Therapeutic Color Therapy Analyzer</h1>
            <p class="subtitle">Transform your environment with scientifically-backed color therapy for mood regulation, health optimization, and circadian rhythm alignment</p>
        </header>

        <div class="main-content">
            <!-- Upload Section -->
            <div class="upload-section">
                <!-- TRIPLE FEATURE TOGGLE SYSTEM -->
                <div class="feature-toggle">
                    <div class="toggle-btn active" id="toggleMood">üé≠ Mood Regulation</div>
                    <div class="toggle-btn active" id="toggleHealth">ü©∫ Health Focus</div>
                    <div class="toggle-btn active" id="toggleEnergy">üîÑ Energy Alignment</div>
                </div>

                <!-- PERSONALIZATION INPUTS -->
                <!-- Health Focus Selection -->
                <div class="form-group" id="healthSection">
                    <h3>ü©∫ Health Focus Area</h3>
                    <div class="health-grid">
                        <div class="health-option selected" data-health="mental">
                            üß† Mental Clarity
                        </div>
                        <div class="health-option" data-health="sleep">
                            üò¥ Sleep Quality
                        </div>
                        <div class="health-option" data-health="energy">
                            ‚ö° Energy Levels
                        </div>
                        <div class="health-option" data-health="stress">
                            üòå Stress Relief
                        </div>
                        <div class="health-option" data-health="immunity">
                            üõ°Ô∏è Immunity Boost
                        </div>
                        <div class="health-option" data-health="heart">
                            ‚ù§Ô∏è Heart Health
                        </div>
                    </div>
                </div>

                <!-- Current Symptoms -->
                <div class="form-group" id="symptomsSection">
                    <h3>üìã Current Symptoms (Select all that apply)</h3>
                    <div class="symptom-grid">
                        <div class="symptom-option" data-symptom="fatigue">Fatigue</div>
                        <div class="symptom-option" data-symptom="anxiety">Anxiety</div>
                        <div class="symptom-option" data-symptom="headache">Headache</div>
                        <div class="symptom-option" data-symptom="insomnia">Insomnia</div>
                        <div class="symptom-option" data-symptom="focus">Lack of focus</div>
                        <div class="symptom-option" data-symptom="mood">Low mood</div>
                    </div>
                </div>

                <!-- Time of Day -->
                <div class="form-group" id="timeSection">
                    <h3>üïí Time of Day Analysis</h3>
                    <div class="time-grid">
                        <div class="time-option selected" data-time="morning">
                            üåÖ<span>Morning</span>
                            <small>6am-10am</small>
                        </div>
                        <div class="time-option" data-time="midday">
                            ‚òÄÔ∏è<span>Midday</span>
                            <small>10am-2pm</small>
                        </div>
                        <div class="time-option" data-time="afternoon">
                            üåá<span>Afternoon</span>
                            <small>2pm-6pm</small>
                        </div>
                        <div class="time-option" data-time="evening">
                            üåô<span>Evening</span>
                            <small>6pm-10pm</small>
                        </div>
                        <div class="time-option" data-time="night">
                            üåö<span>Night</span>
                            <small>10pm-6am</small>
                        </div>
                    </div>
                </div>

                <!-- ENVIRONMENT UPLOAD -->
                <div class="form-group">
                    <h3>üè° Upload Your Environment</h3>
                    <div class="file-upload">
                        <i>üì∏</i>
                        <span>Upload environment photo or selfie</span>
                        <div class="upload-types">
                            Living room ‚Ä¢ Bedroom ‚Ä¢ Workspace ‚Ä¢ Meditation area ‚Ä¢ Wardrobe
                        </div>
                        <input type="file" id="fileInput" accept="image/*">
                    </div>
                    <img id="imagePreview" alt="Environment Preview">
                </div>

                <div class="alert alert-error" id="errorAlert">
                    ‚ùå Please upload an image first!
                </div>

                <div class="alert alert-success" id="successAlert">
                    ‚úÖ Analysis complete! Your therapeutic color prescription is ready.
                </div>

                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Analyzing your environment and creating personalized color therapy...</p>
                </div>

                <button id="analyzeBtn" class="btn-primary">
                    üåà Generate Therapeutic Analysis
                </button>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <div class="results" id="resultsContainer">
                    <!-- Wellness Score -->
                    <div class="wellness-score">
                        <h2>Wellness Score</h2>
                        <div class="score" id="wellnessScore">85%</div>
                        <p>Color Harmony & Therapeutic Alignment</p>
                    </div>

                    <!-- Color Prescription -->
                    <div class="prescription-card" id="colorPrescription">
                        Therapeutic Color Prescription: "Calming Serenity Blue"
                    </div>

                    <!-- Triple Layer Visualization -->
                    <div class="triple-layer">
                        <div class="layer-card layer-1">
                            <h4>üé≠ Emotional Layer</h4>
                            <p id="emotionalLayer">Mood Regulation</p>
                        </div>
                        <div class="layer-card layer-2">
                            <h4>ü©∫ Physical Health Layer</h4>
                            <p id="healthLayer">Health Optimization</p>
                        </div>
                        <div class="layer-card layer-3">
                            <h4>üåø Environmental Layer</h4>
                            <p id="environmentLayer">Space Harmony</p>
                        </div>
                    </div>

                    <!-- ENVIRONMENT ANALYSIS -->
                    <div class="color-section">
                        <h3>üè° Current Environment Analysis</h3>
                        <div class="environment-analysis">
                            <div class="analysis-card">
                                <h4>üé® Dominant Colors</h4>
                                <div class="analysis-value" id="dominantColorCount">5</div>
                                <div class="analysis-text">Colors detected in your environment</div>
                            </div>
                            <div class="analysis-card">
                                <h4>‚öñÔ∏è Color Balance</h4>
                                <div class="analysis-value" id="colorBalance">75%</div>
                                <div class="analysis-text">Optimal harmony score</div>
                            </div>
                            <div class="analysis-card">
                                <h4>üå°Ô∏è Light Temperature</h4>
                                <div class="analysis-value" id="lightTemp">Warm</div>
                                <div class="analysis-text">Affects mood and energy</div>
                            </div>
                            <div class="analysis-card">
                                <h4>üß† Psychological Impact</h4>
                                <div class="analysis-value" id="psychImpact">Calming</div>
                                <div class="analysis-text">Current environment effect</div>
                            </div>
                        </div>
                    </div>

                    <!-- COLOR OUTPUT SECTIONS -->
                    <!-- Mood-Balancing Palette -->
                    <div class="color-section" id="moodColorsSection">
                        <h3>üé≠ Mood-Balancing Palette</h3>
                        <p>Colors to regulate your emotional state</p>
                        <div class="color-palette" id="moodColors">
                            <!-- Mood colors will be inserted here -->
                        </div>
                    </div>

                    <!-- Health-Targeting Colors -->
                    <div class="color-section" id="healthColorsSection">
                        <h3>ü©∫ Health-Targeting Colors</h3>
                        <p>Colors for your specific health focus</p>
                        <div class="color-palette" id="healthColors">
                            <!-- Health colors will be inserted here -->
                        </div>
                    </div>

                    <!-- Environmental Harmony Colors -->
                    <div class="color-section" id="environmentColorsSection">
                        <h3>üåø Environmental Harmony Colors</h3>
                        <p>Colors to optimize your living space</p>
                        <div class="color-palette" id="environmentColors">
                            <!-- Environment colors will be inserted here -->
                        </div>
                    </div>

                    <!-- COLOR THERAPY VISUALIZATION -->
                    <div class="color-section">
                        <h3>üåà Color Therapy Visualization</h3>
                        <p>How colors affect your brain waves and circadian rhythm</p>
                        
                        <div class="circadian-chart">
                            <div class="circadian-wave" id="circadianWave" style="height: 60%;"></div>
                        </div>
                        
                        <div class="color-therapy-timeline">
                            <div class="therapy-time-slot" style="background: linear-gradient(135deg, #ff6b6b, #ff9e6d);">
                                üåÖ Morning<br>Energizing Reds
                            </div>
                            <div class="therapy-time-slot" style="background: linear-gradient(135deg, #ffd166, #06d6a0);">
                                ‚òÄÔ∏è Day<br>Focus Yellows
                            </div>
                            <div class="therapy-time-slot" style="background: linear-gradient(135deg, #118ab2, #9d4edd);">
                                üåá Evening<br>Calming Blues
                            </div>
                            <div class="therapy-time-slot" style="background: linear-gradient(135deg, #9d4edd, #073b4c);">
                                üåô Night<br>Restful Purples
                            </div>
                        </div>
                    </div>

                    <!-- COLOR BREATHING GUIDE -->
                    <div class="breathing-guide">
                        <h3>üå¨Ô∏è 5-Minute Color Breathing Exercise</h3>
                        <p>Follow the circle rhythm for stress relief</p>
                        <div class="breathing-circle">
                            Breathe with Color
                        </div>
                        <p>Inhale calm blue, exhale stress orange</p>
                    </div>

                    <!-- AUDIO SOUNDSCAPES -->
                    <div class="audio-section" id="soundscapesSection">
                        <h3>üéµ Color Therapy Soundscapes</h3>
                        <p>Soothing ambient sounds based on your therapeutic colors</p>
                        
                        <div class="audio-controls">
                            <button class="audio-btn" id="playSoundscape">‚ñ∂Ô∏è</button>
                            <button class="audio-btn stop" id="stopSoundscape">‚èπÔ∏è</button>
                            
                            <div class="volume-control">
                                <label>Volume:</label>
                                <input type="range" min="0" max="1" step="0.1" value="0.7" class="volume-slider" id="soundscapeVolume">
                            </div>
                            
                            <select id="soundscapeType" style="flex: 1; min-width: 200px; padding: 12px; border-radius: 10px; background: rgba(20, 20, 30, 0.9); color: white; border: 2px solid rgba(255,255,255,0.1);">
                                <option value="ambient">üåå Ambient Healing</option>
                                <option value="nature">üåø Nature Harmony</option>
                                <option value="meditative">üßò Meditative Flow</option>
                                <option value="sleep">üí§ Sleep Induction</option>
                            </select>
                        </div>
                        
                        <div class="audio-visualizer" id="soundscapeVisualizer">
                            <!-- Audio bars will be generated here -->
                        </div>
                    </div>

                    <!-- MOOD PLAYLIST -->
                    <div class="playlist-section" id="playlistSection">
                        <h3>üé∂ Therapeutic Playlist</h3>
                        <p>Music that complements your color therapy</p>
                        
                        <div id="playlistTracks">
                            <!-- Playlist tracks will be generated here -->
                        </div>
                    </div>

                    <!-- ADVANCED DATA VISUALIZATION -->
                    <div class="data-dashboard" id="dataDashboard">
                        <div class="data-card">
                            <h4>üìà Therapeutic Sentiment</h4>
                            <div class="sentiment-meter">
                                <div class="sentiment-indicator" id="sentimentIndicator" style="left: 75%;"></div>
                            </div>
                            <div class="sentiment-labels">
                                <span>Negative</span>
                                <span>Neutral</span>
                                <span>Positive</span>
                            </div>
                            <div class="data-metric" id="sentimentScore">+82%</div>
                            <div class="data-label">Emotional healing potential</div>
                        </div>
                        
                        <div class="data-card">
                            <h4>üé® Color Frequency</h4>
                            <div class="color-frequency-chart" id="frequencyChart">
                                <!-- Frequency bars will be generated here -->
                            </div>
                            <div class="data-label">Therapeutic color distribution</div>
                        </div>
                        
                        <div class="data-card">
                            <h4>üß† Neural Harmony</h4>
                            <div class="data-metric" id="harmonyScore">94%</div>
                            <div class="data-label">Brain wave optimization</div>
                            <div class="emotion-wheel">
                                <div class="emotion-pointer" id="emotionPointer">BALANCE</div>
                            </div>
                        </div>
                    </div>

                    <!-- PERSONALIZED HEALTH TIPS -->
                    <div class="therapy-tips">
                        <h3>üí° Personalized Therapy Tips</h3>
                        <ul class="tips-list" id="therapyTips">
                            <li>Use blue tones in your workspace to enhance focus and reduce eye strain</li>
                            <li>Add green plants to introduce natural, calming green hues</li>
                            <li>Use warm yellow lighting in the evening to support melatonin production</li>
                            <li>Wear calming colors during stressful situations</li>
                            <li>Create a color gradient in your room from cool to warm tones</li>
                        </ul>
                    </div>

                    <!-- SCIENTIFIC BACKING -->
                    <div class="color-section">
                        <h3>üî¨ Scientific Backing</h3>
                        <ul class="tips-list">
                            <li>üìö Color psychology research shows blue reduces stress by 15-20%</li>
                            <li>üî¨ Chromotherapy principles: Different wavelengths affect cellular function</li>
                            <li>‚è∞ Circadian science: Morning light exposure regulates sleep-wake cycles</li>
                            <li>üå± Environmental psychology: Green spaces reduce anxiety by 30%</li>
                            <li>üß™ Neuroscience: Colors affect neurotransmitter production and brain wave patterns</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>üåø Therapeutic Color Therapy Analyzer | Powered by Color Psychology √ó Chromotherapy √ó Neuroscience</p>
            <p>All analysis happens locally in your browser - your privacy is protected</p>
            <p>Based on scientific research from color therapy, environmental psychology, and circadian biology</p>
        </footer>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let loadedImageData = null;
        let originalImage = null;
        let selectedMood = "calm";
        let selectedHealth = "mental";
        let selectedSymptoms = new Set();
        let selectedTime = "morning";
        let activeFeatures = {
            mood: true,
            health: true,
            energy: true
        };
        let currentSoundscape = null;
        let audioVisualizerInterval = null;
        let currentTrack = null;

        // ========== INITIALIZATION ==========
        window.addEventListener('load', function() {
            console.log("Therapeutic Color Therapy Analyzer loaded!");
            
            // Initialize default selections
            document.querySelector('.health-option').classList.add('selected');
            document.querySelector('.time-option').classList.add('selected');
            
            // Initialize feature toggles
            initFeatureToggles();
            
            // Initialize event listeners
            initEventListeners();
        });

        // ========== FEATURE TOGGLE SYSTEM ==========
        function initFeatureToggles() {
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const feature = this.id.replace('toggle', '').toLowerCase();
                    activeFeatures[feature] = this.classList.contains('active');
                    updateFeatureSections();
                });
            });
        }

        function updateFeatureSections() {
            // Update visibility based on active features
            const sections = {
                mood: ['moodColorsSection'],
                health: ['healthSection', 'symptomsSection', 'healthColorsSection'],
                energy: ['timeSection']
            };
            
            Object.keys(activeFeatures).forEach(feature => {
                const isActive = activeFeatures[feature];
                if (sections[feature]) {
                    sections[feature].forEach(sectionId => {
                        const section = document.getElementById(sectionId);
                        if (section) {
                            section.style.display = isActive ? 'block' : 'none';
                        }
                    });
                }
            });
        }

        // ========== PERSONALIZATION INPUTS ==========
        function initEventListeners() {
            // Health focus selection
            document.querySelectorAll('.health-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.health-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedHealth = this.dataset.health;
                    console.log("Selected health focus:", selectedHealth);
                });
            });

            // Symptom selection
            document.querySelectorAll('.symptom-option').forEach(option => {
                option.addEventListener('click', function() {
                    const symptom = this.dataset.symptom;
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selectedSymptoms.delete(symptom);
                    } else {
                        this.classList.add('selected');
                        selectedSymptoms.add(symptom);
                    }
                    console.log("Selected symptoms:", Array.from(selectedSymptoms));
                });
            });

            // Time selection
            document.querySelectorAll('.time-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.time-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedTime = this.dataset.time;
                    console.log("Selected time:", selectedTime);
                });
            });

            // File upload
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);

            // Analyze button
            document.getElementById('analyzeBtn').addEventListener('click', analyzeEnvironment);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showError("Please upload an image smaller than 10MB");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = document.getElementById('imagePreview');
                img.src = event.target.result;
                img.style.display = 'block';
                loadedImageData = event.target.result;
                
                originalImage = new Image();
                originalImage.src = event.target.result;
                
                document.getElementById('errorAlert').style.display = 'none';
            };
            reader.onerror = function() {
                showError("Failed to read image file. Please try again.");
            };
            reader.readAsDataURL(file);
        }

        // ========== ENVIRONMENT ANALYSIS ==========
        async function analyzeEnvironment() {
            if (!loadedImageData) {
                showError("Please upload an environment photo first!");
                return;
            }

            // Show loading state
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';
            document.getElementById('successAlert').style.display = 'none';

            try {
                await new Promise((resolve) => {
                    if (originalImage.complete) {
                        resolve();
                    } else {
                        originalImage.onload = resolve;
                    }
                });

                // Extract colors from environment
                const dominantColors = extractDominantColors(originalImage, 12);
                
                // Generate therapeutic color sets
                const moodColors = generateMoodColors(dominantColors[0], selectedMood);
                const healthColors = generateHealthColors(dominantColors[0], selectedHealth);
                const environmentColors = generateEnvironmentColors(dominantColors[0], selectedTime);
                
                // Create analysis results
                const analysisResults = {
                    wellnessScore: calculateWellnessScore(dominantColors, selectedHealth, selectedSymptoms),
                    dominantColors: dominantColors.slice(0, 8),
                    moodColors: moodColors,
                    healthColors: healthColors,
                    environmentColors: environmentColors,
                    colorBalance: calculateColorBalance(dominantColors),
                    lightTemperature: analyzeLightTemperature(dominantColors),
                    psychologicalImpact: analyzePsychologicalImpact(dominantColors),
                    healthFocus: selectedHealth,
                    symptoms: Array.from(selectedSymptoms),
                    timeOfDay: selectedTime
                };

                // Display results
                displayResults(analysisResults);
                
                // Initialize audio features
                initAudioControls();
                generatePlaylist(selectedHealth, selectedTime);
                createDataVisualizations(analysisResults);
                
                // Show success
                document.getElementById('successAlert').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('successAlert').style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error("Analysis error:", error);
                showError("Failed to analyze environment. Please try with a different image.");
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        // ========== COLOR GENERATION FUNCTIONS ==========
        function generateMoodColors(baseColor, mood) {
            const hsv = rgbToHsv(baseColor);
            const [h, s, v] = hsv;
            
            const moodColors = [];
            
            // Mood-specific color adjustments
            switch(mood) {
                case 'calm':
                    moodColors.push(hsvToRgb([210, 0.6, 0.8])); // Calming blue
                    moodColors.push(hsvToRgb([180, 0.5, 0.7])); // Soothing teal
                    moodColors.push(hsvToRgb([270, 0.4, 0.8])); // Relaxing lavender
                    moodColors.push(hsvToRgb([120, 0.4, 0.6])); // Grounding green
                    moodColors.push(hsvToRgb([h, Math.max(0.3, s * 0.6), Math.max(0.5, v)]));
                    break;
                    
                default: // Energizing
                    moodColors.push(hsvToRgb([(h + 0) % 360, Math.min(1, s * 1.4), Math.min(1, v * 1.2)]));
                    moodColors.push(hsvToRgb([(h + 60) % 360, 0.9, 0.95]));
                    moodColors.push(hsvToRgb([(h + 120) % 360, 0.8, 0.9]));
                    moodColors.push(hsvToRgb([(h + 180) % 360, 0.85, 0.85]));
                    moodColors.push(hsvToRgb([(h + 240) % 360, 0.7, 0.95]));
            }
            
            return moodColors.slice(0, 5);
        }

        function generateHealthColors(baseColor, healthFocus) {
            const hsv = rgbToHsv(baseColor);
            const [h, s, v] = hsv;
            
            const healthColors = [];
            
            switch(healthFocus) {
                case 'mental':
                    healthColors.push(hsvToRgb([240, 0.7, 0.7])); // Focus blue
                    healthColors.push(hsvToRgb([120, 0.6, 0.6])); // Clarity green
                    healthColors.push(hsvToRgb([60, 0.8, 0.9])); // Mental energy yellow
                    healthColors.push(hsvToRgb([300, 0.5, 0.8])); // Creativity purple
                    healthColors.push(hsvToRgb([h, s * 0.9, v * 0.9]));
                    break;
                    
                case 'sleep':
                    healthColors.push(hsvToRgb([270, 0.4, 0.7])); // Sleep-inducing lavender
                    healthColors.push(hsvToRgb([210, 0.5, 0.6])); // Calming blue
                    healthColors.push(hsvToRgb([180, 0.4, 0.5])); // Deep teal
                    healthColors.push(hsvToRgb([120, 0.3, 0.4])); // Dark green
                    healthColors.push(hsvToRgb([h, s * 0.6, v * 0.9]));
                    break;
                    
                case 'energy':
                    healthColors.push(hsvToRgb([0, 0.9, 0.9])); // Energy red
                    healthColors.push(hsvToRgb([30, 0.95, 1])); // Vitality orange
                    healthColors.push(hsvToRgb([60, 0.9, 0.95])); // Energy yellow
                    healthColors.push(hsvToRgb([120, 0.7, 0.9])); // Renewal green
                    healthColors.push(hsvToRgb([h, Math.min(1, s * 1.3), Math.min(1, v * 1.1)]));
                    break;
                    
                case 'stress':
                    healthColors.push(hsvToRgb([120, 0.5, 0.7])); // Stress-relief green
                    healthColors.push(hsvToRgb([180, 0.4, 0.8])); // Calming teal
                    healthColors.push(hsvToRgb([270, 0.3, 0.85])); // Relaxing lavender
                    healthColors.push(hsvToRgb([30, 0.5, 0.9])); // Comforting peach
                    healthColors.push(hsvToRgb([h, s * 0.5, v * 0.95]));
                    break;
                    
                default:
                    healthColors.push(hsvToRgb([h, s, v]));
            }
            
            return healthColors.slice(0, 5);
        }

        function generateEnvironmentColors(baseColor, timeOfDay) {
            const hsv = rgbToHsv(baseColor);
            const [h, s, v] = hsv;
            
            const environmentColors = [];
            
            switch(timeOfDay) {
                case 'morning':
                    environmentColors.push(hsvToRgb([60, 0.9, 0.95])); // Morning sun
                    environmentColors.push(hsvToRgb([30, 0.8, 0.9])); // Sunrise orange
                    environmentColors.push(hsvToRgb([210, 0.6, 0.9])); // Morning sky
                    environmentColors.push(hsvToRgb([120, 0.7, 0.85])); // Fresh green
                    environmentColors.push(hsvToRgb([h, Math.min(1, s * 1.1), Math.min(1, v * 1.05)]));
                    break;
                    
                case 'evening':
                    environmentColors.push(hsvToRgb([270, 0.4, 0.7])); // Evening lavender
                    environmentColors.push(hsvToRgb([210, 0.5, 0.6])); // Evening blue
                    environmentColors.push(hsvToRgb([30, 0.5, 0.8])); // Sunset orange
                    environmentColors.push(hsvToRgb([330, 0.4, 0.85])); // Evening pink
                    environmentColors.push(hsvToRgb([h, s * 0.6, v * 0.9]));
                    break;
                    
                case 'night':
                    environmentColors.push(hsvToRgb([270, 0.7, 0.6])); // Deep purple
                    environmentColors.push(hsvToRgb([240, 0.8, 0.5])); // Midnight blue
                    environmentColors.push(hsvToRgb([210, 0.5, 0.4])); // Shadow blue
                    environmentColors.push(hsvToRgb([180, 0.4, 0.3])); // Deep teal
                    environmentColors.push(hsvToRgb([h, s * 0.4, v * 0.7]));
                    break;
                    
                default: // Daytime
                    environmentColors.push(hsvToRgb([h, s, v]));
            }
            
            return environmentColors.slice(0, 5);
        }

        // ========== ANALYSIS FUNCTIONS ==========
        function calculateWellnessScore(colors, healthFocus, symptoms) {
            let baseScore = 70;
            
            // Adjust based on color harmony
            const harmony = calculateColorHarmonyScore(colors);
            baseScore += harmony * 0.3;
            
            // Adjust based on health focus alignment
            switch(healthFocus) {
                case 'mental':
                    baseScore += colors.some(c => {
                        const hsv = rgbToHsv(c);
                        return hsv[0] >= 200 && hsv[0] <= 260; // Blue-purple range
                    }) ? 15 : 5;
                    break;
                case 'sleep':
                    baseScore += colors.some(c => {
                        const hsv = rgbToHsv(c);
                        return hsv[0] >= 250 && hsv[0] <= 300; // Purple range
                    }) ? 18 : 8;
                    break;
            }
            
            // Adjust for symptoms
            const symptomCount = symptoms.size;
            baseScore -= symptomCount * 3;
            
            return Math.min(98, Math.max(60, Math.round(baseScore)));
        }

        function calculateColorBalance(colors) {
            const hsvColors = colors.map(rgbToHsv);
            const avgSaturation = hsvColors.reduce((sum, hsv) => sum + hsv[1], 0) / hsvColors.length;
            const avgBrightness = hsvColors.reduce((sum, hsv) => sum + hsv[2], 0) / hsvColors.length;
            
            // Ideal balance: moderate saturation and brightness
            const saturationScore = 1 - Math.abs(avgSaturation - 0.5);
            const brightnessScore = 1 - Math.abs(avgBrightness - 0.6);
            
            return Math.round((saturationScore + brightnessScore) / 2 * 100);
        }

        function analyzeLightTemperature(colors) {
            const avgHue = colors.reduce((sum, color) => {
                const hsv = rgbToHsv(color);
                return sum + hsv[0];
            }, 0) / colors.length;
            
            if (avgHue < 60 || avgHue > 330) return "Warm";
            if (avgHue >= 60 && avgHue < 180) return "Neutral";
            return "Cool";
        }

        function analyzePsychologicalImpact(colors) {
            const hsvColors = colors.map(rgbToHsv);
            
            const hasCalming = hsvColors.some(hsv => hsv[0] >= 180 && hsv[0] <= 270 && hsv[1] < 0.6);
            const hasEnergizing = hsvColors.some(hsv => (hsv[0] < 60 || hsv[0] > 330) && hsv[1] > 0.7);
            const hasBalancing = hsvColors.some(hsv => hsv[0] >= 90 && hsv[0] <= 150 && hsv[1] > 0.5);
            
            if (hasCalming && !hasEnergizing) return "Calming";
            if (hasEnergizing && !hasCalming) return "Energizing";
            if (hasBalancing) return "Balancing";
            return "Mixed";
        }

        function calculateColorHarmonyScore(colors) {
            if (colors.length < 2) return 0.7;
            
            let totalHarmony = 0;
            let comparisons = 0;
            
            for (let i = 0; i < colors.length; i++) {
                for (let j = i + 1; j < colors.length; j++) {
                    totalHarmony += calculateColorHarmony(colors[i], colors[j]);
                    comparisons++;
                }
            }
            
            return comparisons > 0 ? totalHarmony / comparisons : 0;
        }

        function calculateColorHarmony(color1, color2) {
            const hsv1 = rgbToHsv(color1);
            const hsv2 = rgbToHsv(color2);
            
            const hueDiff = Math.abs(hsv1[0] - hsv2[0]);
            const normalizedHueDiff = Math.min(hueDiff, 360 - hueDiff) / 180;
            
            const satDiff = Math.abs(hsv1[1] - hsv2[1]);
            const valDiff = Math.abs(hsv1[2] - hsv2[2]);
            
            const harmony = 1 - (normalizedHueDiff * 0.6 + satDiff * 0.2 + valDiff * 0.2);
            return Math.max(0, Math.min(1, harmony));
        }

        // ========== DISPLAY RESULTS ==========
        function displayResults(results) {
            document.getElementById('resultsContainer').style.display = 'block';
            
            // Update wellness score
            document.getElementById('wellnessScore').textContent = `${results.wellnessScore}%`;
            
            // Update prescription
            const prescriptionNames = {
                'mental': "Mental Clarity Azure",
                'sleep': "Deep Sleep Indigo",
                'energy': "Vital Energy Amber",
                'stress': "Stress Relief Jade",
                'immunity': "Immune Boost Gold",
                'heart': "Heart Harmony Ruby"
            };
            const prescription = prescriptionNames[results.healthFocus] || "Therapeutic Harmony";
            document.getElementById('colorPrescription').textContent = 
                `Therapeutic Color Prescription: "${prescription}"`;
            
            // Update triple layer visualization
            document.getElementById('emotionalLayer').textContent = 
                getMoodDescription(selectedMood);
            document.getElementById('healthLayer').textContent = 
                getHealthDescription(results.healthFocus);
            document.getElementById('environmentLayer').textContent = 
                getEnvironmentDescription(results.timeOfDay);
            
            // Update environment analysis
            document.getElementById('dominantColorCount').textContent = results.dominantColors.length;
            document.getElementById('colorBalance').textContent = `${results.colorBalance}%`;
            document.getElementById('lightTemp').textContent = results.lightTemperature;
            document.getElementById('psychImpact').textContent = results.psychologicalImpact;
            
            // Update circadian wave
            const waveHeights = {
                'morning': 40,
                'midday': 70,
                'afternoon': 60,
                'evening': 50,
                'night': 30
            };
            document.getElementById('circadianWave').style.height = `${waveHeights[results.timeOfDay] || 50}%`;
            
            // Display color palettes
            displayColorPalette('moodColors', results.moodColors, 'Mood');
            displayColorPalette('healthColors', results.healthColors, 'Health');
            displayColorPalette('environmentColors', results.environmentColors, 'Environment');
            
            // Update therapy tips
            updateTherapyTips(results);
        }

        function displayColorPalette(containerId, colors, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            colors.forEach((color, index) => {
                const colorElement = createColorElement(color, type, index);
                container.appendChild(colorElement);
            });
        }

        function createColorElement(color, type, index) {
            const container = document.createElement('div');
            container.className = 'color-swatch-container';
            
            const colorName = getColorName(color);
            const hex = rgbToHex(color);
            
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = `rgb(${color.join(',')})`;
            swatch.title = `${colorName}\nHEX: ${hex}\nClick to hear therapeutic tone`;
            
            const soundIcon = document.createElement('div');
            soundIcon.className = 'sound-icon';
            soundIcon.innerHTML = 'üîä';
            soundIcon.title = 'Play therapeutic color tone';
            
            soundIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                playTherapeuticTone(color, type);
            });
            
            const label = document.createElement('div');
            label.className = 'color-label';
            label.textContent = `${type} ${index + 1}`;
            
            const hexElement = document.createElement('div');
            hexElement.className = 'color-hex';
            hexElement.textContent = hex;
            
            swatch.appendChild(soundIcon);
            container.appendChild(swatch);
            container.appendChild(label);
            container.appendChild(hexElement);
            
            // Add click to copy functionality
            swatch.addEventListener('click', function() {
                const textToCopy = `${colorName} (${type})\nHEX: ${hex}\nRGB: ${color.join(', ')}`;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalTitle = this.title;
                    this.title = '‚úÖ Copied to clipboard!';
                    setTimeout(() => {
                        this.title = originalTitle;
                    }, 2000);
                });
            });
            
            return container;
        }

        function updateTherapyTips(results) {
            const tipsContainer = document.getElementById('therapyTips');
            if (!tipsContainer) return;
            
            const tips = generateTherapyTips(results);
            tipsContainer.innerHTML = '';
            
            tips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                tipsContainer.appendChild(li);
            });
        }

        function generateTherapyTips(results) {
            const tips = [];
            
            // Time-based tips
            if (results.timeOfDay === 'morning') {
                tips.push("üåÖ Start your day with energizing yellow and orange tones to boost morning energy");
            } else if (results.timeOfDay === 'evening') {
                tips.push("üåô Use calming blues and purples in the evening to prepare your body for rest");
            }
            
            // Health focus tips
            switch(results.healthFocus) {
                case 'mental':
                    tips.push("üß† Incorporate blue tones in your workspace to enhance focus and cognitive function");
                    tips.push("üí≠ Use green accents to reduce eye strain during long work sessions");
                    break;
                case 'sleep':
                    tips.push("üò¥ Avoid blue light from screens 2 hours before bedtime to support melatonin production");
                    tips.push("üåå Use deep purple or indigo in your bedroom to promote restful sleep");
                    break;
                case 'stress':
                    tips.push("üòå Surround yourself with green and blue tones during stressful periods");
                    tips.push("üåø Add plants to introduce natural, calming green hues into your environment");
                    break;
            }
            
            // Symptom-based tips
            if (results.symptoms.includes('fatigue')) {
                tips.push("‚ö° Use bright yellow or orange accents to combat afternoon fatigue");
            }
            if (results.symptoms.includes('anxiety')) {
                tips.push("üßò Practice color breathing with blue tones for immediate anxiety relief");
            }
            
            // General tips
            tips.push("üé® Create a color gradient in your room from cool to warm tones for balanced energy");
            tips.push("üëó Wear colors that match your therapeutic palette for all-day benefits");
            tips.push("üíß Stay hydrated - water enhances your body's response to color therapy");
            
            return tips.slice(0, 6);
        }

        // ========== AUDIO FUNCTIONALITY ==========
        const colorToFrequency = {
            'red': 329.63, 'orange': 293.66, 'yellow': 261.63,
            'green': 220.00, 'blue': 196.00, 'purple': 174.61,
            'pink': 155.56, 'white': 130.81, 'black': 110.00,
            'gray': 98.00, 'brown': 87.31
        };

        const therapeuticPlaylists = {
            'mental': [
                { title: "Focus Flow", duration: "4:20", color: "#3498db", vibe: "üß† Concentration" },
                { title: "Clarity Waves", duration: "5:10", color: "#2ecc71", vibe: "üí° Mental clarity" },
                { title: "Mindful Moments", duration: "6:30", color: "#9b59b6", vibe: "üßò Focus" }
            ],
            'sleep': [
                { title: "Deep Sleep Journey", duration: "8:15", color: "#34495e", vibe: "üò¥ Sleep induction" },
                { title: "Nighttime Serenity", duration: "7:40", color: "#9b59b6", vibe: "üåå Relaxation" },
                { title: "Dream Weaver", duration: "10:20", color: "#2c3e50", vibe: "üí§ Deep rest" }
            ],
            'stress': [
                { title: "Anxiety Relief", duration: "5:45", color: "#3498db", vibe: "üòå Calming" },
                { title: "Stress Melt", duration: "6:20", color: "#1abc9c", vibe: "üåä Soothing" },
                { title: "Peaceful Mind", duration: "7:10", color: "#2980b9", vibe: "üßò Meditation" }
            ]
        };

        function initAudioControls() {
            const playBtn = document.getElementById('playSoundscape');
            const stopBtn = document.getElementById('stopSoundscape');
            const volumeSlider = document.getElementById('soundscapeVolume');
            const soundscapeType = document.getElementById('soundscapeType');
            
            playBtn.addEventListener('click', function() {
                if (currentSoundscape) {
                    currentSoundscape.stop();
                    currentSoundscape = null;
                }
                startTherapeuticSoundscape(soundscapeType.value);
            });
            
            stopBtn.addEventListener('click', function() {
                if (currentSoundscape) {
                    currentSoundscape.stop();
                    currentSoundscape = null;
                    stopAudioVisualizer();
                }
            });
            
            volumeSlider.addEventListener('input', function() {
                if (currentSoundscape) {
                    currentSoundscape.setVolume(this.value);
                }
            });
        }

        function startTherapeuticSoundscape(type) {
            const colors = getCurrentColors();
            if (colors.length === 0) return;
            
            currentSoundscape = generateTherapeuticSoundscape(colors, type);
            startAudioVisualizer();
        }

        function generateTherapeuticSoundscape(colors, type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const masterGain = audioContext.createGain();
            masterGain.gain.value = 0.4; // Lower volume for therapeutic use
            masterGain.connect(audioContext.destination);
            
            const oscillators = [];
            
            colors.forEach((color, index) => {
                const colorName = getColorName(color).toLowerCase();
                let baseFreq = colorToFrequency[colorName] || 174.61; // Default to calming frequency
                
                // Adjust for therapeutic effect
                const hsv = rgbToHsv(color);
                let frequency;
                
                switch(type) {
                    case 'sleep':
                        frequency = baseFreq * 0.7; // Lower frequencies for sleep
                        break;
                    case 'meditative':
                        frequency = baseFreq * 0.9; // Calming frequencies
                        break;
                    default:
                        frequency = baseFreq * (0.8 + hsv[2] * 0.2);
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine'; // Smooth sine wave
                gainNode.gain.value = 0.05; // Very low volume for background
                oscillator.frequency.value = frequency;
                oscillator.detune.value = (Math.random() - 0.5) * 8; // Gentle detuning
                
                // Add slow modulation for therapeutic effect
                const lfo = audioContext.createOscillator();
                const lfoGain = audioContext.createGain();
                lfo.frequency.value = 0.08 + Math.random() * 0.15; // Very slow
                lfoGain.gain.value = 0.1;
                
                lfo.connect(lfoGain);
                lfoGain.connect(gainNode.gain);
                
                oscillator.connect(gainNode);
                gainNode.connect(masterGain);
                
                oscillators.push({ oscillator, gainNode, lfo, lfoGain });
            });
            
            oscillators.forEach(osc => {
                osc.oscillator.start();
                osc.lfo.start();
            });
            
            return {
                stop: function() {
                    oscillators.forEach(osc => {
                        osc.gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 2);
                        setTimeout(() => {
                            osc.oscillator.stop();
                            osc.lfo.stop();
                        }, 2000);
                    });
                    setTimeout(() => audioContext.close(), 3000);
                },
                setVolume: function(volume) {
                    masterGain.gain.value = volume * 0.6; // Keep therapeutic volume low
                }
            };
        }

        function playTherapeuticTone(color, type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            const hsv = rgbToHsv(color);
            const colorName = getColorName(color).toLowerCase();
            let baseFreq = colorToFrequency[colorName] || 196.00;
            
            // Adjust frequency based on therapeutic type
            let frequency;
            switch(type) {
                case 'Mood':
                    frequency = baseFreq * (0.7 + hsv[2] * 0.3);
                    break;
                case 'Health':
                    frequency = baseFreq * (0.8 + hsv[1] * 0.2);
                    break;
                case 'Environment':
                    frequency = baseFreq * (0.9 + hsv[0] / 360 * 0.1);
                    break;
                default:
                    frequency = baseFreq;
            }
            
            oscillator.type = 'triangle'; // Softer than sine for therapeutic effect
            oscillator.frequency.value = frequency;
            
            // Gentle envelope
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.5);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 3);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 3);
            
            setTimeout(() => audioContext.close(), 3500);
        }

        function startAudioVisualizer() {
            const visualizer = document.getElementById('soundscapeVisualizer');
            visualizer.innerHTML = '';
            
            for (let i = 0; i < 45; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                visualizer.appendChild(bar);
            }
            
            const bars = visualizer.querySelectorAll('.audio-bar');
            
            audioVisualizerInterval = setInterval(() => {
                bars.forEach((bar, index) => {
                    const time = Date.now() / 1000;
                    const height = 15 + Math.sin(time * 0.4 + index * 0.15) * 40 + 
                                   Math.sin(time * 0.2 + index * 0.08) * 15;
                    bar.style.height = height + 'px';
                    
                    const hue = 220 + Math.sin(time * 0.08 + index * 0.03) * 50;
                    bar.style.background = `linear-gradient(to top, 
                        hsl(${hue}, 50%, 65%), 
                        hsl(${hue + 30}, 40%, 45%))`;
                });
            }, 80);
        }

        function stopAudioVisualizer() {
            if (audioVisualizerInterval) {
                clearInterval(audioVisualizerInterval);
                audioVisualizerInterval = null;
            }
            
            const visualizer = document.getElementById('soundscapeVisualizer');
            const bars = visualizer.querySelectorAll('.audio-bar');
            bars.forEach(bar => {
                bar.style.height = '2px';
                bar.style.transition = 'height 1s ease';
            });
        }

        function generatePlaylist(healthFocus, timeOfDay) {
            const playlist = therapeuticPlaylists[healthFocus] || therapeuticPlaylists.mental;
            const container = document.getElementById('playlistTracks');
            if (!container) return;
            
            container.innerHTML = '';
            
            playlist.forEach((track, index) => {
                const trackElement = document.createElement('div');
                trackElement.className = 'playlist-track';
                
                trackElement.innerHTML = `
                    <div class="track-number">${index + 1}</div>
                    <div class="track-color" style="background: ${track.color}"></div>
                    <div class="track-info">
                        <div class="track-title">${track.title}</div>
                        <div class="track-duration">${track.duration} ‚Ä¢ ${track.vibe}</div>
                    </div>
                `;
                
                trackElement.addEventListener('click', function() {
                    playTherapeuticTrack(track, index);
                    document.querySelectorAll('.playlist-track').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
                
                container.appendChild(trackElement);
            });
        }

        function playTherapeuticTrack(track, index) {
            if (currentTrack === index) return;
            currentTrack = index;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            const hex = track.color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const frequency = 120 + (r / 255) * 180; // Therapeutic frequency range
            
            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            gainNode.gain.value = 0.15;
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            
            setTimeout(() => {
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.5);
                setTimeout(() => {
                    oscillator.stop();
                    currentTrack = null;
                    document.querySelectorAll('.playlist-track').forEach(t => t.classList.remove('active'));
                    audioContext.close();
                }, 1600);
            }, 4000);
        }

        // ========== DATA VISUALIZATION ==========
        function createDataVisualizations(results) {
            updateSentimentMeter(results);
            createFrequencyChart(results.dominantColors);
            updateHarmonyScore(results);
            updateEmotionWheel(results.healthFocus);
        }

        function updateSentimentMeter(results) {
            let sentimentScore = 0;
            
            // Combine all colors for sentiment analysis
            const allColors = [
                ...results.dominantColors,
                ...results.moodColors,
                ...results.healthColors,
                ...results.environmentColors
            ];
            
            allColors.forEach(color => {
                const hsv = rgbToHsv(color);
                const hue = hsv[0];
                
                // Therapeutic sentiment mapping
                if (hue >= 200 && hue <= 260) sentimentScore += 0.9; // Calming blues
                else if (hue >= 90 && hue <= 150) sentimentScore += 0.8; // Balancing greens
                else if (hue >= 270 && hue <= 330) sentimentScore += 0.7; // Spiritual purples
                else if (hue >= 30 && hue <= 60) sentimentScore += 0.6; // Energizing yellows
                else sentimentScore += 0.5;
            });
            
            const avgSentiment = sentimentScore / Math.max(1, allColors.length);
            const percentage = Math.round(avgSentiment * 100);
            
            const sentimentScoreElement = document.getElementById('sentimentScore');
            const sentimentIndicator = document.getElementById('sentimentIndicator');
            
            if (sentimentScoreElement) {
                sentimentScoreElement.textContent = `+${percentage}%`;
            }
            if (sentimentIndicator) {
                sentimentIndicator.style.left = `${percentage}%`;
            }
        }

        function createFrequencyChart(colors) {
            const container = document.getElementById('frequencyChart');
            if (!container) return;
            
            container.innerHTML = '';
            
            const colorCounts = {};
            colors.forEach(color => {
                const colorName = getColorName(color);
                colorCounts[colorName] = (colorCounts[colorName] || 0) + 1;
            });
            
            const maxCount = Math.max(...Object.values(colorCounts));
            const colorNames = Object.keys(colorCounts);
            
            colorNames.forEach(colorName => {
                const count = colorCounts[colorName];
                const heightPercentage = (count / maxCount) * 100;
                
                const column = document.createElement('div');
                column.className = 'frequency-column';
                column.style.height = `${heightPercentage}%`;
                
                const value = document.createElement('div');
                value.className = 'frequency-value';
                value.textContent = count;
                
                const sampleColor = colors.find(c => getColorName(c) === colorName);
                if (sampleColor) {
                    column.style.background = `linear-gradient(to top, 
                        rgb(${sampleColor.join(',')}), 
                        rgba(${sampleColor.join(',')}, 0.6))`;
                }
                
                column.appendChild(value);
                container.appendChild(column);
            });
        }

        function updateHarmonyScore(results) {
            const harmonyScore = Math.min(99, results.wellnessScore + 5);
            const harmonyElement = document.getElementById('harmonyScore');
            if (harmonyElement) {
                harmonyElement.textContent = `${harmonyScore}%`;
            }
        }

        function updateEmotionWheel(healthFocus) {
            const focusAngles = {
                'mental': 240,    // Blue area for focus
                'sleep': 270,     // Purple area for rest
                'energy': 30,     // Red area for energy
                'stress': 180,    // Green area for calm
                'immunity': 120,  // Green area for health
                'heart': 0        // Red area for vitality
            };
            
            const angle = focusAngles[healthFocus] || 180;
            const pointer = document.getElementById('emotionPointer');
            if (!pointer) return;
            
            const radius = 110;
            const x = Math.cos((angle - 90) * Math.PI / 180) * radius;
            const y = Math.sin((angle - 90) * Math.PI / 180) * radius;
            
            pointer.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
            pointer.textContent = healthFocus.substring(0, 4).toUpperCase();
        }

        // ========== HELPER FUNCTIONS ==========
        function getCurrentColors() {
            const colorSwatches = Array.from(document.querySelectorAll('.color-swatch'));
            return colorSwatches.map(swatch => {
                const bg = swatch.style.backgroundColor;
                const match = bg.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                return match ? [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])] : null;
            }).filter(color => color !== null);
        }

        function getMoodDescription(mood) {
            const descriptions = {
                'calm': 'Soothing & Relaxing',
                'energetic': 'Vibrant & Uplifting',
                'creative': 'Inspiring & Expressive',
                'focused': 'Concentrated & Clear',
                'social': 'Engaging & Warm',
                'resting': 'Peaceful & Restorative'
            };
            return descriptions[mood] || 'Balanced & Harmonious';
        }

        function getHealthDescription(healthFocus) {
            const descriptions = {
                'mental': 'Cognitive Enhancement',
                'sleep': 'Rest Optimization',
                'energy': 'Vitality Boost',
                'stress': 'Anxiety Reduction',
                'immunity': 'Immune Support',
                'heart': 'Cardiovascular Health'
            };
            return descriptions[healthFocus] || 'Wellness Support';
        }

        function getEnvironmentDescription(timeOfDay) {
            const descriptions = {
                'morning': 'Energizing Sunrise',
                'midday': 'Balanced Daylight',
                'afternoon': 'Productive Glow',
                'evening': 'Calming Sunset',
                'night': 'Restful Darkness'
            };
            return descriptions[timeOfDay] || 'Harmonious Space';
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            if (errorAlert) {
                errorAlert.innerHTML = `‚ùå ${message}`;
                errorAlert.style.display = 'block';
            }
        }

        // ========== COLOR UTILITY FUNCTIONS ==========
        // (Keep the rgbToHsv, hsvToRgb, rgbToHex, getColorName, extractDominantColors functions from previous code)
        // These should be copied from your original working code
        function rgbToHsv(rgb) {
            const [r, g, b] = rgb.map(c => c / 255);
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, v = max;
            
            const d = max - min;
            s = max === 0 ? 0 : d / max;
            
            if (max === min) {
                h = 0;
            } else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            
            return [h * 360, s, v];
        }

        function hsvToRgb(hsv) {
            const [h, s, v] = hsv;
            const c = v * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = v - c;
            
            let r, g, b;
            
            if (h < 60) [r, g, b] = [c, x, 0];
            else if (h < 120) [r, g, b] = [x, c, 0];
            else if (h < 180) [r, g, b] = [0, c, x];
            else if (h < 240) [r, g, b] = [0, x, c];
            else if (h < 300) [r, g, b] = [x, 0, c];
            else [r, g, b] = [c, 0, x];
            
            return [
                Math.round((r + m) * 255),
                Math.round((g + m) * 255),
                Math.round((b + m) * 255)
            ];
        }

        function rgbToHex(rgb) {
            const [r, g, b] = rgb;
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        function getColorName(rgb) {
            const hsv = rgbToHsv(rgb);
            const [h, s, v] = hsv;
            
            if (s < 0.15) {
                if (v > 0.85) return "White";
                if (v > 0.7) return "Light Gray";
                if (v > 0.4) return "Gray";
                if (v > 0.2) return "Dark Gray";
                return "Black";
            }
            
            if ((h >= 0 && h < 12) || h >= 348) return "Red";
            if (h >= 12 && h < 40) return "Orange";
            if (h >= 40 && h < 70) return "Yellow";
            if (h >= 70 && h < 90) return "Lime Green";
            if (h >= 90 && h < 160) return "Green";
            if (h >= 160 && h < 195) return "Turquoise";
            if (h >= 195 && h < 255) return "Blue";
            if (h >= 255 && h < 285) return "Purple";
            if (h >= 285 && h < 315) return "Magenta";
            if (h >= 315 && h < 348) return "Pink";
            
            return "Color";
        }

        function extractDominantColors(img, numColors = 8) {
            // Simplified color extraction - in production, use the advanced k-means from your original code
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const maxDimension = 300;
            let width = img.width;
            let height = img.height;
            
            if (width > maxDimension || height > maxDimension) {
                const ratio = Math.min(maxDimension / width, maxDimension / height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            const imageData = ctx.getImageData(0, 0, width, height);
            const pixels = imageData.data;
            
            // Simple color sampling
            const sampledColors = [];
            const gridSize = 4;
            
            for (let y = 0; y < height; y += gridSize) {
                for (let x = 0; x < width; x += gridSize) {
                    const index = (y * width + x) * 4;
                    const r = pixels[index];
                    const g = pixels[index + 1];
                    const b = pixels[index + 2];
                    const a = pixels[index + 3];
                    
                    if (a < 200) continue;
                    
                    sampledColors.push([r, g, b]);
                }
            }
            
            // Simple grouping (replace with k-means in production)
            const groups = {};
            sampledColors.forEach(color => {
                const key = `${Math.round(color[0]/32)*32},${Math.round(color[1]/32)*32},${Math.round(color[2]/32)*32}`;
                groups[key] = groups[key] || { sum: [0, 0, 0], count: 0 };
                groups[key].sum[0] += color[0];
                groups[key].sum[1] += color[1];
                groups[key].sum[2] += color[2];
                groups[key].count++;
            });
            
            const colors = Object.values(groups)
                .sort((a, b) => b.count - a.count)
                .slice(0, numColors)
                .map(group => [
                    Math.round(group.sum[0] / group.count),
                    Math.round(group.sum[1] / group.count),
                    Math.round(group.sum[2] / group.count)
                ]);
            
            // Ensure we have enough colors
            while (colors.length < numColors) {
                const baseColor = colors[0] || [128, 128, 128];
                const hueShift = (colors.length * 45) % 360;
                const hsv = rgbToHsv(baseColor);
                hsv[0] = (hsv[0] + hueShift) % 360;
                colors.push(hsvToRgb(hsv));
            }
            
            return colors;
        }
    </script>
</body>
</html>
